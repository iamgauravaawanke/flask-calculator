<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flask Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; padding: 20px; transition: background-color 0.3s, color 0.3s; }
    .history { max-height: 200px; overflow-y: auto; cursor: pointer; }
    .card { margin-bottom: 20px; transition: background-color 0.3s, color 0.3s; }
    .btn-space { margin: 2px; }
    #result { font-weight: bold; color: #0d6efd; }
    #memoryValue { font-weight: bold; color: #198754; }

    .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
    .calc-buttons button { font-size: 1.5rem; padding: 15px; transition: background-color 0.3s, color 0.3s; }
    #expression { font-size: 1.5rem; padding: 10px; text-align: right; transition: background-color 0.3s, color 0.3s; }

    /* Dark Mode */
    body.dark-mode { background-color: #121212; color: #e0e0e0; }
    body.dark-mode .card { background-color: #1e1e1e; color: #e0e0e0; }
    body.dark-mode input { background-color: #2c2c2c; color: #e0e0e0; }
    body.dark-mode button { border-color: #333; }

    /* Highlight animation for new history entry */
    .history-item-new {
      background-color: #d1e7dd !important;
      transition: background-color 1s;
    }

    @media (max-width: 576px) {
      .calc-buttons button { font-size: 1.3rem; padding: 12px; }
      #expression { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4 text-center">Flask Calculator</h1>

  <!-- Dark Mode Toggle -->
  <div class="d-flex justify-content-center mb-3">
    <button class="btn btn-dark btn-sm" id="toggleDarkMode">Toggle Dark Mode</button>
  </div>

  <!-- Calculator Card -->
  <div class="card p-3 shadow-sm">
    <input type="text" id="expression" class="form-control mb-3" placeholder="Enter e.g. 7 + 3">

    <div class="calc-buttons">
      <button class="btn btn-light btn-space" onclick="appendInput('7')">7</button>
      <button class="btn btn-light btn-space" onclick="appendInput('8')">8</button>
      <button class="btn btn-light btn-space" onclick="appendInput('9')">9</button>
      <button class="btn btn-warning btn-space" onclick="appendInput('+')">+</button>

      <button class="btn btn-light btn-space" onclick="appendInput('4')">4</button>
      <button class="btn btn-light btn-space" onclick="appendInput('5')">5</button>
      <button class="btn btn-light btn-space" onclick="appendInput('6')">6</button>
      <button class="btn btn-warning btn-space" onclick="appendInput('-')">-</button>

      <button class="btn btn-light btn-space" onclick="appendInput('1')">1</button>
      <button class="btn btn-light btn-space" onclick="appendInput('2')">2</button>
      <button class="btn btn-light btn-space" onclick="appendInput('3')">3</button>
      <button class="btn btn-warning btn-space" onclick="appendInput('*')">*</button>

      <button class="btn btn-light btn-space" onclick="appendInput('0')">0</button>
      <button class="btn btn-light btn-space" onclick="appendInput('.')">.</button>
      <button class="btn btn-success btn-space" onclick="calculate()">=</button>
      <button class="btn btn-warning btn-space" onclick="appendInput('/')">/</button>

      <button class="btn btn-secondary btn-space" onclick="backspace()">‚Üê</button>
      <button class="btn btn-danger btn-space" onclick="clearInput()">C</button>
    </div>

    <div class="mt-2 d-flex flex-wrap justify-content-center">
      <button class="btn btn-warning btn-space" onclick="memoryAdd()">M+</button>
      <button class="btn btn-warning btn-space" onclick="memorySubtract()">M-</button>
      <button class="btn btn-info btn-space" onclick="memoryRecall()">MR</button>
      <button class="btn btn-danger btn-space" onclick="memoryClear()">MC</button>
    </div>

    <div class="mt-2 text-center">
      <strong>Result:</strong> <span id="result">0</span> &nbsp; | &nbsp;
      <strong>Memory:</strong> <span id="memoryValue">0</span>
    </div>
  </div>

  <!-- History Card -->
  <div class="card p-3 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>History</h5>
      <div>
        <button class="btn btn-danger btn-sm btn-space" onclick="clearHistory()">Clear All</button>
        <button class="btn btn-secondary btn-sm btn-space" onclick="undoHistory()">Undo Last</button>
      </div>
    </div>
    <ul id="historyList" class="list-group history"></ul>
  </div>
</div>

<script>
  document.getElementById("toggleDarkMode").onclick = () => {
    document.body.classList.toggle("dark-mode");
  };

  function appendInput(value) { document.getElementById("expression").value += value; }
  function backspace() { const expr = document.getElementById("expression"); expr.value = expr.value.slice(0, -1); }
  function clearInput() { document.getElementById("expression").value = ""; }

  async function calculate() {
    const expression = document.getElementById("expression").value;
    const response = await fetch("/calculate", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `expression=${encodeURIComponent(expression)}`
    });
    const data = await response.json();
    if(data.result !== undefined){
      document.getElementById("result").innerText = data.result;
      loadHistory();
    } else { alert(data.error); }
  }

  async function loadHistory() {
    const response = await fetch("/history");
    const data = await response.json();
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";

    data.history.forEach((item, index) => {
      const li = document.createElement("li");
      li.className = "list-group-item";
      li.innerText = `${index + 1}. ${item}`;

      li.onclick = () => {
        const expr = item.split(" | ")[1].split(" = ")[0];
        document.getElementById("expression").value = expr;
      };

      historyList.appendChild(li);

      // Highlight newest entry
      if(index === 0){
        li.classList.add("history-item-new");
        setTimeout(() => li.classList.remove("history-item-new"), 1000);
      }
    });
  }

  async function clearHistory() { await fetch("/history/clear", { method: "POST" }); loadHistory(); }
  async function undoHistory() { await fetch("/history/undo", { method: "POST" }); loadHistory(); }

  async function memoryAdd() { const response = await fetch("/memory/add", { method: "POST" }); const data = await response.json(); document.getElementById("memoryValue").innerText = data.memory; }
  async function memorySubtract() { const response = await fetch("/memory/subtract", { method: "POST" }); const data = await response.json(); document.getElementById("memoryValue").innerText = data.memory; }
  async function memoryRecall() { const response = await fetch("/memory/recall"); const data = await response.json(); document.getElementById("expression").value = data.memory; document.getElementById("result").innerText = data.memory; document.getElementById("memoryValue").innerText = data.memory; }
  async function memoryClear() { const response = await fetch("/memory/clear", { method: "POST" }); const data = await response.json(); document.getElementById("memoryValue").innerText = data.memory; }

  window.onload = () => { loadHistory(); memoryRecall(); };
</script>
</body>
</html>
